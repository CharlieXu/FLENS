=========================================
Full Storage Schemes and General Matrices                               [TOC]
=========================================

The term _general matrix_ refers to a matrix that is not necessarily square or
symmetric.  Further, _full storage_ denotes that for a $m \times n$ matrix
all its $m \cdot n$ elements are stored somewhere in memory.

In FLENS a matrix type always includes an underlying storage type.  The general
idea of this is well known in the LAPACK/BLAS world.  However, in the
traditional Fortran LAPACK/BLAS this is merley done by conventions.  It is
completely up to the programmer how to interpretate some data.  When you pass
a double array to `dgetrs` its treated as a general matrix, if you pass it to
`dtrtrs` as a triangular matrix.  On the on hand it is flexible on the other
hand it can be error prone.

In FLENS/C++ you get language support through strong typing.  That means errors
can be detected by the compiler.  You will see on later slides that at the same
time we do not loose flexibility.


Full Storage Schemes
====================
FLENS defines three template classes for full storage schemes:

- *Template Class* __FullStorage__

  Constructors of __FullStorage__ allocate memory and the destructor deallocates
  it.  The first template parameter specifies the element type.  The second
  parameter specifies whether elements get stored row-wise (RowMajor) or
  column-wise (ColMahor).

  It is guaranteed that elements are stored contiguously in memory, i.e. without
  any gaps.

  Examples:

  +-------------------------------+--------------------------------------------+
  |`FullStorage<double, ColMajor>`|  Full storage scheme that allocates memory |
  |                               |  when instantiated.  Elements are stored   |
  |                               |  contiguously and _column-wise_.           |
  +-------------------------------+--------------------------------------------+
  |`FullStorage<double, RowMajor>`|  Full storage scheme that allocates memory |
  |                               |  when instantiated.  Elements are stored   |
  |                               |  contiguously and _row-wise_.              |
  +-------------------------------+--------------------------------------------+
  |`FullStorage<double>`          |  The second template parameter of          |
  |                               |  `FullStorage` defaults to `ColMajor`.     |
  |                               |  Hence this is equivalent to               |
  |                               |  `FullStorage<double, ColMajor>`.          |
  +-------------------------------+--------------------------------------------+

  Creating an instance of type __FullStorage__ involves dynamic memory
  allocation.  So you do not want to create an instance inside a loop or
  function.

- *Template Class* __FullStorageView__

  A storage view does not allocate or release any memory.  It is just used to
  reference elements that were originally allocated by a still existing and
  living `FullStorage` instance.

  An instance of type __FullStorageView__ just contains a pointer to raw data
  and some integers for matrix dimensions and element strides.  If you are
  familiar with BLAS/LAPACK That is essentially what you have to pass to a
  BLAS/LAPACK function: dimensions, pointer and leading dimension.

  Creating an instance of type __FullStorageView__ is cheap as it just
  initializes a few integer values of a struct/class.  The destructor does
  nothing.

- *Template Class* __ConstFullStorageView__

  Instances of __ConstFullStorageView__ are used for const-referencing elements
  from an existing and living `FullStorage` instance.

  The creation/destruction of an __ConstFullStorageView__ instance is cheap.

Further template parameters of the storage classes allow to change the default
index type (which is `long), the default index base (which is 1) and the memory
allocator.


GeMatrix: General Matrix with Full Storage
==========================================
The __GeMatrix__ class has only one template parameter that defines the
underlying storage scheme.  That means we give the storage scheme a
mathematical meaning.

Examples:

+-----------------------------------------------------+----------------------------------------------------+
|`GeMatrix<FullStorage<double, ColMajor> >`           | A general matrix where memory gets allocated       |
|                                                     | when instanciated and released at the end of       |
|                                                     | its scop.                                          |
+-----------------------------------------------------+----------------------------------------------------+
|`GeMatrix<FullStorage<double, ColMajor> >::View`     | A general matrix that references a rectangular     |
|                                                     | part of another `GeMatrix` instance. Memory        |
|                                                     | neither gets allocated nor released at any         |
|                                                     | point.  Creation/destruction is cheap.             |
|                                                     |                                                    |
|                                                     | `View` is a publib typedef in `GeMatrix` and       |
|                                                     | in this case defined as                            |
|                                                     | `GeMatrix<FullStorageView<double, ColMajor> >`     |
+-----------------------------------------------------+----------------------------------------------------+
|`GeMatrix<FullStorage<double, ColMajor> >::ConstView`| A general matrix that references a rectangular     |
|                                                     | part of another `GeMatrix` instance. Memory        |
|                                                     | neither gets allocated nor released at any         |
|                                                     | point.  Creation/destruction is cheap              |
|                                                     |                                                    |
|                                                     | Calling any non-const methods will cause a compile |
|                                                     | time error.  So this is a read-only matrix view.   |
|                                                     |                                                    |
|                                                     | `ConstView` is a public typedef in   `GeMatrix`    |
|                                                     | and in this case defined as                        |
|                                                     | `GeMatrix<ConstFullStorageView<double, ColMajor> >`|
+-----------------------------------------------------+----------------------------------------------------+

Some Public Typedefs
--------------------

+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `IndexType`                                       | Like its name suggests the type used for indexing.|
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `ElementType`                                     | The element type.                                 |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `View`, `ConstView`                               | Types for referencing a rectangular part of the   |
|                                                   | matrix.                                           |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `NoView`                                          | Matrix type with memory allocation.  If you want  |
|                                                   | to copy matrix parts instead of referencing use   |
|                                                   | this type.                                        |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `EngineView`, `EngineConstView`                   | Storage schemes for referencing parts from        |
|                                                   | another storage scheme. For `GeMatrix` these are  |
|                                                   | typedefs for `FullStorageView<..>` and            |
|                                                   | `ConstFullStorageView<..>`.                       |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+



Some Methods and operations for Matrix Manipulation
---------------------------------------------------

+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `GeMatrix(IndexType m, IndexType n)`              | Constructor for a $m \times n$ matrix.            |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `IndexType`                                       | Return the number of rows.                        |
| `numRows() const`                                 |                                                   |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `IndexType numCols() const`                       | Return the number of columns.                     |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `const ElementType& operator()(i, j) const`       | Return a reference to element in row $i$ and      |
|                                                   | column $j$.                                       |
+---------------------------------------------------+                                                   |
|                                                   |                                                   |
| `ElementType& operator()(i, j)`                   |                                                   |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+
|                                                   |                                                   |
| `Initializer operator=(const ElementType &value)` | List initializer.                                 |
|                                                   |                                                   |
|                                                   | Allows to initialize the matrix with a comma      |
|                                                   | separated list of values.                         |
|                                                   |                                                   |
|                                                   | If the list contains only a single value it is    |
|                                                   | used to fill the matrix.                          |
|                                                   |                                                   |
+---------------------------------------------------+---------------------------------------------------+

By default indices start at 1, i.e. the index base is 1.  Usually that is what you want in
numerical linear algebra.  However, we will see that it is fairly easy to change this if
desired.  In this case the following methods become usefull.

+---------------------------------------------+---------------------------------------------------+
|                                             |                                                   |
| `IndexType firstRow() const`                | Return the index of the first row.                |
|                                             |                                                   |
+---------------------------------------------+---------------------------------------------------+
|                                             |                                                   |
| `IndexType lastRow() const`                 | Return the index of the last row.                 |
|                                             |                                                   |
+---------------------------------------------+---------------------------------------------------+
|                                             |                                                   |
| `IndexType firstCol() const`                | Return the index of the first column.             |
|                                             |                                                   |
+---------------------------------------------+---------------------------------------------------+
|                                             |                                                   |
| `IndexType lastCol() const`                 | Return the index of the last column.              |
|                                             |                                                   |
+---------------------------------------------+---------------------------------------------------+


Simple Example for using `GeMatrix`
===================================
In a first example we show:

 - How to allocate a general matrix with full storage.
 - How to explicitly initialize all elements with the list initializer.
 - How to fill the matrix with a single value.
 - How to access/manipulate a particular matrix entry.
 - How to retrieve matrix dimensions and index ranges.

Example Code
------------
:import: flens/examples/tut01-page01-example1.cc [stripped, downloadable]

Comments on Example Code
------------------------
:import: flens/examples/tut01-page01-example1.cc [brief]

Compile and Run
---------------

   *--[SHELL]-----------------------------------------------------------------*
   |                                                                          |
   |  cd flens/examples                                                       |
   |  g++ -Wall -std=c++11 -I../.. tut01-page01-example1.cc                   |
   |  ./a.out                                                                 |
   |                                                                          |
   *--------------------------------------------------------------------------*


Simple Example for using `GeMatrix` Views
=========================================
In a first example we show:

 - How to create `GeMatrix` views that reference rectangular parts of another
   `GeMatrix` instance.
 - There are two view variants, i.e. const-views and (non-const-)views.


Example Code
------------
:import: flens/examples/tut01-page01-example2.cc [stripped, downloadable]

Comments on Example Code
------------------------
:import: flens/examples/tut01-page01-example2.cc [brief]


Compile and Run
---------------

   *--[SHELL]-----------------------------------------------------------------*
   |                                                                          |
   |  cd flens/examples                                                       |
   |  g++ -Wall -std=c++11 -I../.. tut01-page01-example2.cc                   |
   |  ./a.out                                                                 |
   |                                                                          |
   *--------------------------------------------------------------------------*


Write in C!!!
=============
If you haven't done already you really have to checkout __Write in C__!!

FLENS was developed in the spirit: _How would you do it in C or Fortan? And
How can it be generalized or simplified without sacrifices in C++?_.  So a good
way of understanding concepts is boiling them down to simple C.

Looking at FLENS with C eyeglasses
----------------------------------
So here we port back some of the essential parts of the previous example to C.
This pretty much explains what gets done:

- What does the constructor/destructor of `GeMatrix`: *allocate/release memory*
- What does the constructor/destructor of `GeMatrix` views: *Not much/Nothing*
- What happen when you create a view: *Just setting a pointer to the right
  place*
- What happens when you access elements using the function operator: *Some
  pointer arithmetic done correct and dereferencing*

:import: flens/examples/tut01-page01-example3.cc

Compile and Run
---------------
   *--[SHELL]-----------------------------------------------------------------*
   |                                                                          |
   |  cd flens/examples                                                       |
   |  g++ -Wall -std=c++11 -I../.. tut01-page01-example3.cc                   |
   |  ./a.out                                                                 |
   |                                                                          |
   *--------------------------------------------------------------------------*


More on Selecting Rectangular Parts from `GeMatrix`
===================================================
From a `GeMatrix` instance you can select rectangular parts be specifying
row and column ranges.  This can have the following forms:
 - `all`
 - `from:to`
 - `from:step:to`
In FLENS this is realized through the template classes `Underscore` and `Range`.
The template parameter specifies the index type using in the `GeMatrix`
instance, which is usually `long`:

 - An object of type `Underscore` always means `all`.  And giving such an object
   the name `_` gives a compact notation.

   ---- CODE(type=cc) ----------------------------------------------------------
   Underscore<long>  _;
   -----------------------------------------------------------------------------

 - Objects of type `Range` can be created by calling the function operator of
   `Underscore`:

   ---- CODE(type=cc) ----------------------------------------------------------
   Range<long>  range1  _(1,5);     // 1:5
   Range<long>  range2  _(1,2,5);   // 1:2:5
   -----------------------------------------------------------------------------

 - If for some reason you want a *view of a complete matrix* you don't have to
   select ranges.  Simply construct the view from the original matrix:

   ---- CODE(type=cc) ----------------------------------------------------------
   typedef GeMatrix<FullStorage<double, ColMajor> >      DGeMatrix;
   typedef DGeMatrix::View                               DGeMatrixView;
   typedef DGeMatrix::ConstView                          DGeMatrixConstView;

   DGeMatrix                  A(5, 8);
   DGeMatrixView              X = A;      // X is a view of A
   const DGeMatrixConstView   Y = A;      // Y is a const-view of A
   -----------------------------------------------------------------------------

Note that if you use `from:step:to` ranges the resulting `GeMatrix` view will
be neither `ColMajor` nor `RowMajor`.  We call the storage order in this case
`Grid`.  To our knowledge only `BLIS` and `ulmBLAS` efficiently support linear
algebra operations for this kind of views.


Matrix-View Gotchas
===================
Short and simple version:  Always declare a const-view as const.

A bit longer: As the underlying storage scheme of a const-view only implements
const-methods calling a non-const method of `GeMatrix` always causes a compile
time error.  Using static asserts we try to make this error messages more
readable.

Technically it would be possible to disable in such a cause all non-const
methods of `GeMatrix` using the `std::enable_if` trait.  However, declaring a
const-view not as const is a flaw.  And we don't want to encourage flaws.


Example Code
------------
:import: flens/examples/tut01-page01-example4.cc [stripped, downloadable]

Comments on Example Code
------------------------
:import: flens/examples/tut01-page01-example4.cc [brief]


Compile and Run
---------------

   *--[SHELL]-----------------------------------------------------------------*
   |                                                                          |
   |  cd flens/examples                                                       |
   |  g++ -Wall -std=c++11 -I../.. tut01-page01-example4.cc                   |
   |                                                                          |
   *--------------------------------------------------------------------------*



Using `auto` when dealing with `GeMatrix` Views
===============================================
The `auto` feature in C++11 is a great way to simplify C++ code.  But it is
common sense that you actually understand this C++ feature.  Otherwise don't use
it.  The C++ compiler knows the rules that determine the actual type represented
by `auto`.  And so should you!  If you do, the code becomes more readable for
you.  If you don't, the code become obscure.

There is a nice talk by Scott Meyers __Type Deduction and Why You Care__.  Have
a look at it before you blindly use `auto`.

Fortunately deducing the type of `auto` becomes simple and transparent if you
recall:

  - If `A` is of type `GeMatrix<FullStorage<double, ColMajor> >` then
    `A(_(1,3),_(2,5))` returns

    - the type `GeMatrix<ConstFullStorageView<double, ColMajor> >` if `A` is in
      *const context* and

    - the type `GeMatrix<FullStorageView<double, ColMajor> >` *otherwise*.

  - If `A` is of type `GeMatrix<FullStorageView<double, ColMajor> >` then
    `A(_(1,3),_(2,5))` returns

    - the type `GeMatrix<ConstFullStorageView<double, ColMajor> >` if `A` is in
      *const context* and

    - the type `GeMatrix<FullStorageView<double, ColMajor> >` *otherwise*.

  - If `A` is of type `GeMatrix<ConstFullStorageView<double, ColMajor> >`
    then `A` *must be in const context*  and always returns the type
    `GeMatrix<ConstFullStorageView<double, ColMajor> >`.

Example
-------
So consider the following example and deduce the type of auto in each case:

:import: flens/examples/tut01-page01-example5.cc [stripped, downloadable]



:links: GeMatrix        -> doc:flens/matrixtypes/general/impl/gematrix
        FullStorage     -> doc:flens/storage/fullstorage/fullstorage
        FullStorageView -> doc:flens/storage/fullstorage/fullstorageview
        ConstFullStorageView -> doc:flens/storage/fullstorage/constfullstorageview
        Write in C      -> https://www.youtube.com/watch?v=1S1fISh-pag
        Type Deduction and Why You Care -> https://www.youtube.com/watch?v=wQxj20X-tIU



:navigate: __up__    -> doc:flens/examples/tutorial
           __next__  -> doc:flens/examples/tut01-page02
